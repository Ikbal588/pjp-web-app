<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJP Reporting 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a252f; --accent: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); }
        #sidebar { width: 320px; background: var(--primary); color: white; padding: 25px; overflow-y: auto; }
        .plan-card { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); }
        #main-content { flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .admin-btn { position: absolute; top: 20px; right: 20px; background: #95a5a6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        .visit-row { display: grid; grid-template-columns: 40px 1fr; gap: 15px; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        select, input[type="date"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        .submit-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 30px; }
        #status-bar { position: fixed; bottom: 0; width: 100%; background: #222; color: #0f0; padding: 5px 20px; font-size: 11px; z-index: 1000; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        .dev-row { background-color: #fff5f5; color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

<div id="status-bar">System: Starting...</div>

<div id="sidebar">
    <h2 style="margin-top:0">Today's PJP</h2>
    <p id="planMeta">Loading names...</p>
    <div id="planList"></div>
</div>

<div id="main-content">
    <button class="admin-btn" onclick="adminLogin()">Admin Dashboard</button>

    <div id="tlSection" class="container">
        <h1>Multi-Visit Reporting</h1>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label><b>TL Name:</b></label>
                <select id="tlName" onchange="loadPlan()"><option>Loading...</option></select>
            </div>
            <div>
                <label><b>Visit Date:</b></label>
                <input type="date" id="visitDate" onchange="loadPlan()">
            </div>
        </div>
        
        <div id="bulkEntryForm" class="hidden">
            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
            <p style="color: #666;">Select all stores visited today (Fill 1-10 rows as needed):</p>
            <div id="rowsContainer"></div>
            <button class="submit-btn" onclick="submitAll()">Submit All Visits</button>
        </div>
    </div>

    <div id="adminSection" class="container hidden" style="max-width: 1000px;">
        <h1>Admin Dashboard</h1>
        <button onclick="downloadExcel()" style="background: #3498db; color:white; padding:10px; border:none; border-radius:4px; cursor:pointer;">Download Excel</button>
        <button onclick="location.reload()" style="margin-left:10px;">Logout</button>
        <table id="adminTable">
            <thead>
                <tr><th>TL Name</th><th>Date</th><th>Outlet</th><th>Status</th></tr>
            </thead>
            <tbody id="adminBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- DATABASE CONFIG ---
    const SB_URL = 'https://rtodwltrkammqzrpufds.supabase.co'; 
    const SB_KEY = 'sb_publishable_BIlXBBrujH3VtyvGy_XPlQ_CZl7GXx7';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let masterStores = [];
    let plannedStores = [];
    let choiceInstances = [];

    function updateStatus(msg) { document.getElementById('status-bar').innerText = "SYSTEM: " + msg; }

    async function init() {
        try {
            updateStatus("Fetching TL Names...");
            // Double quotes are required for columns with spaces
            const { data: tls, error: e1 } = await sb.from('pjp_master').select('"TL Name"');
            if(e1) throw e1;

            const uniqueNames = [...new Set(tls.map(t => t['TL Name']))].filter(Boolean).sort();
            const tlSelect = document.getElementById('tlName');
            tlSelect.innerHTML = '<option value="">-- Select Your Name --</option>';
            uniqueNames.forEach(n => tlSelect.innerHTML += `<option value="${n}">${n}</option>`);

            updateStatus("Fetching Master Stores...");
            const { data: stores, error: e2 } = await sb.from('pjp_master').select('"Outlet Name", Location');
            if(e2) throw e2;
            masterStores = stores;
            
            generateRows();
            updateStatus("Ready. RLS Policies Active.");
            document.getElementById('planMeta').innerText = "Select TL and Date...";
        } catch (err) {
            updateStatus("CRITICAL ERROR: " + err.message);
            console.error(err);
        }
    }

    function generateRows() {
        const container = document.getElementById('rowsContainer');
        // Deduplicate stores for the dropdown
        const uniqueStoreList = [...new Map(masterStores.map(s => [s['Outlet Name'], s])).values()];
        
        for (let i = 1; i <= 10; i++) {
            const row = document.createElement('div');
            row.className = 'visit-row';
            row.innerHTML = `<div style="font-weight:bold; color:#999">${i}</div><select id="v_${i}"><option value="">-- Select Outlet Visited --</option></select>`;
            container.appendChild(row);

            const selectEl = document.getElementById(`v_${i}`);
            uniqueStoreList.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s['Outlet Name'];
                opt.text = `${s['Outlet Name']} | ${s.Location}`;
                selectEl.appendChild(opt);
            });

            choiceInstances.push(new Choices(selectEl, { searchEnabled: true, searchResultLimit: 1000, itemSelectText: '' }));
        }
    }

    async function loadPlan() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        if(!name || !date) return;

        updateStatus(`Loading Plan for ${name}...`);
        const { data, error } = await sb.from('pjp_master').select('*').eq('TL Name', name).eq('Date', date);
        
        if(error) { updateStatus("Error: " + error.message); return; }

        plannedStores = data.map(d => d['Outlet Name']);
        document.getElementById('planList').innerHTML = data.map(p => `
            <div class="plan-card"><b>${p['Outlet Name']}</b><br><small>${p.Location}</small></div>
        `).join('');
        
        const hasData = data.length > 0;
        document.getElementById('planMeta').innerText = hasData ? "Today's Plan:" : "No plan found.";
        document.getElementById('bulkEntryForm').classList.toggle('hidden', !hasData);
        updateStatus(hasData ? "Plan Loaded Successfully." : "Ready.");
    }

    async function submitAll() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        const entries = [];

        for(let i = 1; i <= 10; i++) {
            const val = document.getElementById(`v_${i}`).value;
            if(val) {
                entries.push({
                    tl_name: name,
                    visit_date: date,
                    actual_store: val,
                    is_deviation: !plannedStores.includes(val)
                });
            }
        }

        if(entries.length === 0) return alert("Please select at least one visit.");

        updateStatus("Submitting " + entries.length + " visits...");
        const { error } = await sb.from('daily_reports').insert(entries);
        
        if(!error) {
            alert("Success! Your reports have been submitted.");
            location.reload();
        } else {
            alert("Submission Error: " + error.message);
            updateStatus("Submit Failed: " + error.message);
        }
    }

    function adminLogin() {
        if(prompt("Admin Password:") === "admin123") {
            document.getElementById('tlSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            fetchAdmin();
        }
    }

    async function fetchAdmin() {
        const { data } = await sb.from('daily_reports').select('*').order('visit_date', { ascending: false });
        document.getElementById('adminBody').innerHTML = data.map(r => `
            <tr class="${r.is_deviation ? 'dev-row' : ''}">
                <td>${r.tl_name}</td><td>${r.visit_date}</td><td>${r.actual_store}</td><td>${r.is_deviation ? '❌ Deviation' : '✅ Match'}</td>
            </tr>
        `).join('');
        window.reportsData = data;
    }

    function downloadExcel() {
        const ws = XLSX.utils.json_to_sheet(window.reportsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, "PJP_Summary.xlsx");
    }

    init();
</script>
</body>
</html>
