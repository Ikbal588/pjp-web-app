<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJP Reporting System 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1a252f; --accent: #27ae60; --bg: #f4f7f6; --text: #2c3e50; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); }
        
        /* Sidebar Styles */
        #sidebar { width: 320px; background: var(--primary); color: white; padding: 25px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .plan-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 5px solid var(--accent); }
        .sidebar-header { border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; padding-bottom: 10px; }

        /* Main Content */
        #main-content { flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 35px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .admin-btn { position: absolute; top: 20px; right: 20px; background: #7f8c8d; color: white; border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.3s; }
        .admin-btn:hover { background: #34495e; }

        /* Form Elements */
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        select, input[type="date"] { width: 100%; padding: 12px; border: 1px solid #dcdde1; border-radius: 8px; font-size: 16px; transition: border 0.3s; }
        
        .visit-row { display: grid; grid-template-columns: 45px 1fr; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f2f6; }
        .visit-idx { background: #f1f2f6; color: #7f8c8d; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 12px; }

        .submit-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 30px; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); }
        .submit-btn:hover { background: #219150; transform: translateY(-1px); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .dev-badge { background: #fff5f5; color: #e74c3c; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .hidden { display: none; }
        #loader { position: fixed; bottom: 20px; right: 20px; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 30px; font-size: 12px; display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2 style="margin:0">Visit Plan</h2>
        <p style="font-size: 0.8em; opacity: 0.7;">2026 Reporting System</p>
    </div>
    <p id="planMeta">Please select your name and the visit date to view your PJP plan here.</p>
    <div id="planList"></div>
</div>

<div id="main-content">
    <button class="admin-btn" onclick="adminLogin()">Admin Portal</button>

    <div id="tlSection" class="container">
        <h1 style="margin-top:0; font-size: 24px;">Daily Visit Reporting</h1>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group">
                <label>Team Leader Name</label>
                <select id="tlName" onchange="loadPlan()"></select>
            </div>
            <div class="input-group">
                <label>Visit Date</label>
                <input type="date" id="visitDate" onchange="loadPlan()">
            </div>
        </div>
        
        <div id="bulkEntryForm" class="hidden">
            <h3 style="margin: 30px 0 10px 0; font-size: 16px; border-top: 1px solid #eee; pt: 20px;">Select Visited Outlets</h3>
            <div id="rowsContainer"></div>
            <button class="submit-btn" onclick="submitAllVisits()">Submit All Visits</button>
        </div>
    </div>

    <div id="adminSection" class="container hidden" style="max-width: 1000px;">
        <h1 style="margin-top:0">Admin Dashboard</h1>
        <div style="margin-bottom: 25px; display: flex; gap: 10px;">
            <button onclick="downloadExcel()" style="background: #3498db; color:white; padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Export to Excel</button>
            <button onclick="location.reload()" style="background: #95a5a6; color:white; padding:12px 20px; border:none; border-radius:8px; cursor:pointer;">Logout</button>
        </div>
        <div id="adminStats" style="font-weight:bold; color: #e74c3c; margin-bottom: 15px;"></div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>TL Name</th>
                        <th>Date</th>
                        <th>Actual Outlet</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="loader">Processing Request...</div>

<script>
    // --- DATABASE CONFIGURATION ---
    const SB_URL = 'https://rtodwltrkammqzrpufds.supabase.co'; 
    const SB_KEY = 'sb_publishable_BIlXBBrujH3VtyvGy_XPlQ_CZl7GXx7';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let masterStoreList = [];
    let plannedStoresList = [];
    let choiceInstances = [];

    // --- INITIALIZATION ---
    async function init() {
        showLoader(true);
        try {
            // Fetch TLs using exact header from your file "TL Name"
            const { data: tls } = await sb.from('pjp_master').select('"TL Name"');
            const uniqueNames = [...new Set(tls.map(t => t['TL Name']))].filter(Boolean).sort();
            
            const tlSelect = document.getElementById('tlName');
            tlSelect.innerHTML = '<option value="">-- Click to Select --</option>';
            uniqueNames.forEach(n => tlSelect.innerHTML += `<option value="${n}">${n}</option>`);

            // Fetch Stores using exact header "Outlet Name"
            const { data: stores } = await sb.from('pjp_master').select('"Outlet Name", Location');
            masterStoreList = stores;
            
            generateEntryRows();
        } catch (err) {
            console.error(err);
            alert("Database Error: Check connection and RLS settings.");
        }
        showLoader(false);
    }

    function generateEntryRows() {
        const container = document.getElementById('rowsContainer');
        container.innerHTML = "";
        for (let i = 1; i <= 10; i++) {
            const row = document.createElement('div');
            row.className = 'visit-row';
            row.innerHTML = `
                <div class="visit-idx">${i}</div>
                <select id="visit_${i}">
                    <option value="">-- No Visit / Leave Empty --</option>
                </select>
            `;
            container.appendChild(row);

            const selectEl = document.getElementById(`visit_${i}`);
            // Remove duplicates for cleaner search
            const uniqueStores = Array.from(new Set(masterStoreList.map(s => s['Outlet Name'])))
                .map(name => masterStoreList.find(s => s['Outlet Name'] === name));

            uniqueStores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s['Outlet Name'];
                opt.text = `${s['Outlet Name']} | ${s.Location}`;
                selectEl.appendChild(opt);
            });

            const choice = new Choices(selectEl, {
                searchEnabled: true,
                searchResultLimit: 1000,
                renderChoiceLimit: 1000,
                itemSelectText: '',
                placeholder: true
            });
            choiceInstances.push(choice);
        }
    }

    // --- LOGIC ---
    async function loadPlan() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        if(!name || !date) return;

        showLoader(true);
        const { data } = await sb.from('pjp_master').select('*').eq('TL Name', name).eq('Date', date);
        plannedStoresList = data.map(d => d['Outlet Name']);
        
        const listDiv = document.getElementById('planList');
        const meta = document.getElementById('planMeta');
        
        if(data && data.length > 0) {
            meta.innerHTML = `Showing plan for <b>${name}</b>:`;
            listDiv.innerHTML = data.map(p => `
                <div class="plan-card">
                    <b>${p['Outlet Name']}</b><br>
                    <small>${p.Location}</small>
                </div>
            `).join('');
            document.getElementById('bulkEntryForm').classList.remove('hidden');
        } else {
            meta.innerText = "No planned visits found for this date.";
            listDiv.innerHTML = "";
            document.getElementById('bulkEntryForm').classList.add('hidden');
        }
        showLoader(false);
    }

    async function submitAllVisits() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        const batch = [];

        for(let i = 1; i <= 10; i++) {
            const val = document.getElementById(`visit_${i}`).value;
            if(val && val !== "") {
                batch.push({
                    tl_name: name,
                    visit_date: date,
                    actual_store: val,
                    is_deviation: !plannedStoresList.includes(val)
                });
            }
        }

        if(batch.length === 0) return alert("Please select at least one visit location.");

        showLoader(true);
        const { error } = await sb.from('daily_reports').insert(batch);
        showLoader(false);

        if(!error) {
            alert(`✅ Successfully submitted ${batch.length} visits.`);
            location.reload();
        } else {
            alert("❌ Error: " + error.message);
        }
    }

    // --- ADMIN ---
    function adminLogin() {
        const pass = prompt("Admin Password:");
        if(pass === "admin123") {
            document.getElementById('tlSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            fetchAdminData();
        } else if (pass !== null) {
            alert("Incorrect Password.");
        }
    }

    async function fetchAdminData() {
        showLoader(true);
        const { data } = await sb.from('daily_reports').select('*').order('visit_date', { ascending: false });
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = "";
        let devs = 0;

        data.forEach(r => {
            if(r.is_deviation) devs++;
            const tr = document.createElement('tr');
            if(r.is_deviation) tr.className = "deviation-row";
            tr.innerHTML = `
                <td>${r.tl_name}</td>
                <td>${r.visit_date}</td>
                <td>${r.actual_store}</td>
                <td>${r.is_deviation ? '<span class="dev-badge">DEVIATION</span>' : '✅ MATCH'}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('adminStats').innerText = `Current System Deviations: ${devs}`;
        window.reportsData = data;
        showLoader(false);
    }

    function downloadExcel() {
        if(!window.reportsData) return;
        const ws = XLSX.utils.json_to_sheet(window.reportsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "PJP_Report");
        XLSX.writeFile(wb, `PJP_Report_${new Date().toLocaleDateString()}.xlsx`);
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
    }

    init();
</script>
</body>
</html>
