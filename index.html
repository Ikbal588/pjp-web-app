<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJP Multi-Visit Reporting 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1a252f; --accent: #27ae60; --bg: #f4f7f6; --error: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: row; min-height: 100vh; background: var(--bg); }
        #sidebar { width: 320px; background: var(--primary); color: white; padding: 25px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        #main-content { flex-grow: 1; padding: 20px; overflow-y: auto; position: relative; width: 100%; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .plan-card { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--accent); }
        .slot-tag { font-size: 0.75em; color: #27ae60; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; display: block; }
        .admin-btn { position: absolute; top: 10px; right: 10px; background: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; z-index: 100; }
        .hidden { display: none; }
        .visit-row { display: grid; grid-template-columns: 35px 1fr; gap: 10px; align-items: start; padding: 15px 0; border-bottom: 1px solid #eee; }
        .visit-num { font-weight: bold; color: #7f8c8d; padding-top: 12px; text-align: center; }
        .entry-container { display: flex; flex-direction: column; gap: 5px; }
        .manual-toggle { font-size: 11px; color: #3498db; cursor: pointer; text-decoration: underline; width: fit-content; }
        select, input[type="date"], .manual-input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .manual-input { background-color: #fff9e6; border-color: #f1c40f; }
        .submit-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .filter-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 0.85em; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .deviation-row { background-color: #fff5f5; color: var(--error); font-weight: bold; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; max-height: 250px; }
            .filter-bar { grid-template-columns: 1fr; }
            .admin-btn { position: relative; width: 100%; margin-bottom: 10px; top: 0; right: 0; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin-top:0">Today's PJP Plan</h2>
    <div id="planList"><p style="color: #bdc3c7;">Select TL and Date to view plan...</p></div>
</div>

<div id="main-content">
    <button class="admin-btn" onclick="adminLogin()">Admin Login</button>

    <div id="tlSection" class="container">
        <h1>Visit Reporting</h1>
        <div class="filter-bar">
            <div>
                <label><b>TL Name:</b></label>
                <select id="tlName" onchange="loadPlan()"></select>
            </div>
            <div>
                <label><b>Date:</b></label>
                <input type="date" id="visitDate" onchange="loadPlan()">
            </div>
        </div>
        
        <div id="bulkEntryForm" class="hidden">
            <div id="rowsContainer"></div>
            <button class="submit-btn" onclick="submitAllVisits()">Save All Visits</button>
        </div>
    </div>

    <div id="adminSection" class="container hidden">
        <h1>Admin Dashboard</h1>
        <div class="filter-bar">
            <div><label>Filter by TL:</label><select id="filterTL" onchange="applyFilters()"></select></div>
            <div><label>Filter by Date:</label><input type="date" id="filterDate" onchange="applyFilters()"></div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="downloadExcel()" style="background: #3498db; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; flex:2;">Download Filtered Excel</button>
            <button onclick="location.reload()" style="background: #95a5a6; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; flex:1;">Logout</button>
        </div>
        <h3 id="devCountDisplay" style="color: var(--error); margin: 5px 0;"></h3>
        <div class="table-wrapper">
            <table id="adminTable">
                <thead>
                    <tr><th>TL Name</th><th>Date</th><th>Entry #</th><th>Actual Store Visited</th><th>Status</th></tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://rtodwltrkammqzrpufds.supabase.co'; 
    const SB_KEY = 'sb_publishable_BIlXBBrujH3VtyvGy_XPlQ_CZl7GXx7';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let masterStoreList = [];
    let dailyPlanStrings = []; // Stores stores planned for current selection
    let allReports = [];
    let allPlans = [];

    async function init() {
        try {
            const { data: tls } = await sb.from('pjp_master').select('tl_name');
            const uniqueNames = [...new Set(tls.map(t => t.tl_name))];
            const fillSelect = (id) => {
                const el = document.getElementById(id);
                el.innerHTML = '<option value="">-- All --</option>';
                uniqueNames.forEach(n => el.innerHTML += `<option value="${n}">${n}</option>`);
            };
            fillSelect('tlName');
            fillSelect('filterTL');

            const { data: stores } = await sb.from('pjp_master').select('store_name, location');
            masterStoreList = stores;
            generateRows();
        } catch (err) { console.error("Init Error", err); }
    }

    function generateRows() {
        const container = document.getElementById('rowsContainer');
        container.innerHTML = "";
        for (let i = 1; i <= 10; i++) {
            const row = document.createElement('div');
            row.className = 'visit-row';
            row.innerHTML = `
                <div class="visit-num">${i}</div>
                <div class="entry-container" id="container_${i}">
                    <div id="wrapper_select_${i}">
                        <select id="v_${i}" class="store-select">
                            <option value="">-- Select Outlet --</option>
                        </select>
                    </div>
                    <input type="text" id="manual_v_${i}" class="manual-input hidden" placeholder="Enter Store Name & Location manually...">
                    <span class="manual-toggle" id="toggle_${i}" onclick="toggleManual(${i})">Store not listed? Enter manually</span>
                </div>
            `;
            container.appendChild(row);
            const selectEl = document.getElementById(`v_${i}`);
            masterStoreList.forEach(s => {
                const opt = document.createElement('option');
                opt.value = `${s.store_name} | ${s.location}`;
                opt.text = `${s.store_name} | ${s.location}`;
                selectEl.appendChild(opt);
            });
            new Choices(selectEl, { searchEnabled: true, itemSelectText: '', placeholder: true, position: 'bottom' });
        }
    }

    function toggleManual(id) {
        const selectWrap = document.getElementById(`wrapper_select_${id}`);
        const manualInput = document.getElementById(`manual_v_${id}`);
        const toggleBtn = document.getElementById(`toggle_${id}`);
        const isHidden = manualInput.classList.contains('hidden');
        manualInput.classList.toggle('hidden', !isHidden);
        selectWrap.classList.toggle('hidden', isHidden);
        toggleBtn.innerText = isHidden ? "Switch back to list" : "Store not listed? Enter manually";
        toggleBtn.style.color = isHidden ? "#e74c3c" : "#3498db";
    }

    async function loadPlan() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        if(!name || !date) return;
        const { data } = await sb.from('pjp_master').select('*').eq('tl_name', name).eq('visit_date', date);
        
        // Store strings of planned stores for flexible validation
        dailyPlanStrings = data.map(p => `${p.store_name} | ${p.location}`);
        
        const listDiv = document.getElementById('planList');
        listDiv.innerHTML = data.length > 0 ? "" : "<p>No plan found.</p>";
        data.forEach((p, idx) => {
            listDiv.innerHTML += `<div class="plan-card"><span class="slot-tag">Planned Store</span><b>${p.store_name}</b><br><small>${p.location}</small></div>`;
        });
        document.getElementById('bulkEntryForm').classList.toggle('hidden', data.length === 0);
    }

    async function submitAllVisits() {
        const name = document.getElementById('tlName').value;
        const date = document.getElementById('visitDate').value;
        const entries = [];

        for(let i = 1; i <= 10; i++) {
            const manualInp = document.getElementById(`manual_v_${i}`);
            const selectVal = document.getElementById(`v_${i}`).value;
            const finalVal = (!manualInp.classList.contains('hidden') && manualInp.value) ? manualInp.value : selectVal;

            if(finalVal) {
                // Check if finalVal exists anywhere in the day's plan
                const isMatch = dailyPlanStrings.includes(finalVal);
                entries.push({ 
                    tl_name: name, 
                    visit_date: date, 
                    actual_store: finalVal, 
                    is_deviation: !isMatch, 
                    visit_order: i 
                });
            }
        }

        if(entries.length === 0) return alert("Please report at least one visit.");
        const { error } = await sb.from('daily_reports').insert(entries);
        if(!error) { alert("Report saved successfully!"); location.reload(); }
        else { alert("Error: " + error.message); }
    }

    async function adminLogin() {
        if(prompt("Password:") === "admin123") {
            document.getElementById('tlSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            const { data: r } = await sb.from('daily_reports').select('*').order('visit_date', { ascending: false });
            allReports = r;
            applyFilters();
        }
    }

    function applyFilters() {
        const tl = document.getElementById('filterTL').value;
        const date = document.getElementById('filterDate').value;
        const filtered = allReports.filter(r => (!tl || r.tl_name === tl) && (!date || r.visit_date === date));
        renderAdminTable(filtered);
    }

    function renderAdminTable(data) {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = "";
        let devs = 0;
        window.currentExport = [];
        data.forEach(r => {
            if(r.is_deviation) devs++;
            const tr = document.createElement('tr');
            if(r.is_deviation) tr.className = "deviation-row";
            tr.innerHTML = `<td>${r.tl_name}</td><td>${r.visit_date}</td><td>${r.visit_order}</td><td>${r.actual_store}</td><td>${r.is_deviation ? '❌ Deviation' : '✅ Match'}</td>`;
            tbody.appendChild(tr);
            window.currentExport.push({ "TL": r.tl_name, "Date": r.visit_date, "Entry #": r.visit_order, "Actual Store": r.actual_store, "Result": r.is_deviation ? "Deviation" : "Match" });
        });
        document.getElementById('devCountDisplay').innerText = `Total Records: ${data.length} | Deviations: ${devs}`;
    }

    function downloadExcel() {
        if(!window.currentExport || window.currentExport.length === 0) return alert("No data to export.");
        const ws = XLSX.utils.json_to_sheet(window.currentExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, `PJP_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    init();
</script>
</body>
</html>
